
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WealthWise AI | Autonomous Daily Finance Insights</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">

  <style>
    :root{
      --primary-blue:#0f172a;
      --accent-gold:#c5a059;
      --bg:#f8fafc;
      --muted:#64748b;
      --white:#fff;
      --transition:all .25s ease;
    }
    *{box-sizing:border-box}
    body{
      font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      margin:0;background:var(--bg);color:#102a43;line-height:1.6;
    }

    header{
      background:var(--primary-blue);color:var(--white);padding:16px 5%;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:30;
    }
    .logo{font-family:'Playfair Display',serif;color:var(--accent-gold);font-weight:700;font-size:1.5rem;text-decoration:none}
    nav ul{display:flex;gap:18px;list-style:none;margin:0;padding:0}
    nav a{color:var(--white);text-decoration:none;font-weight:600;font-size:.85rem;opacity:.95}

    .controls{display:flex;gap:12px;align-items:center}
    .btn{background:var(--accent-gold);border:none;color:var(--primary-blue);padding:8px 12px;border-radius:8px;font-weight:700;cursor:pointer}
    .btn.secondary{background:transparent;color:var(--white);border:1px solid rgba(255,255,255,.08)}
    .status{background:#fff0d9;color:var(--primary-blue);padding:6px 10px;border-radius:999px;font-weight:700;font-size:.78rem}

    .hero{
      padding:60px 5% 40px;background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(15,23,42,.82)),url('https://images.unsplash.com/photo-1579621970563-ebec7560ff3e?auto=format&fit=crop&q=80&w=1600') center/cover;color:var(--white);text-align:center
    }
    .hero h1{font-family:'Playfair Display',serif;font-size:2.6rem;margin-bottom:12px}
    .hero p{max-width:780px;margin:0 auto;color:#cbd5e1;font-size:1.05rem}

    main{max-width:1200px;margin:28px auto;padding:0 5%;display:grid;grid-template-columns:1fr 300px;gap:24px}
    .blog-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:18px}
    .card{
      background:var(--white);border-radius:12px;overflow:hidden;box-shadow:0 6px 18px rgba(2,6,23,.06);display:flex;flex-direction:column;cursor:pointer;transition:var(--transition);border:1px solid #e6eef6;
    }
    .card:hover{transform:translateY(-6px)}
    .card .img-wrap{width:100%;height:180px;overflow:hidden;background:#e2e8f0}
    .card img{width:100%;height:100%;object-fit:cover;display:block}
    .card-body{padding:16px}
    .tag{color:var(--accent-gold);font-weight:800;font-size:.72rem;text-transform:uppercase;letter-spacing:1px}
    .card h3{font-family:'Playfair Display',serif;margin:8px 0;font-size:1.1rem;color:var(--primary-blue)}
    .card p{color:var(--muted);font-size:.95rem;margin:0 0 10px}

    aside .box{background:var(--white);padding:16px;border-radius:10px;border:1px solid #e6eef6;margin-bottom:16px}
    .small-muted{font-size:.86rem;color:var(--muted)}

    /* Post view */
    #post-view{display:none;padding:36px 5% 40px}
    .post-content{max-width:860px;margin:0 auto;background:var(--white);padding:24px;border-radius:12px;border:1px solid #e6eef6}
    .post-content h1{font-family:'Playfair Display',serif;font-size:2rem;color:var(--primary-blue)}
    .post-content .post-img{width:100%;border-radius:10px;margin:16px 0}

    /* Settings modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;align-items:center;justify-content:center;padding:24px;z-index:60}
    .modal{background:var(--white);padding:20px;border-radius:10px;max-width:720px;width:100%;box-shadow:0 12px 40px rgba(2,6,23,.35)}
    .form-row{display:flex;gap:12px;margin-bottom:10px}
    .form-row label{flex:0 0 140px;align-self:center}
    .form-row input,textarea,select{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef6}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    footer{background:var(--primary-blue);color:#94a3b8;padding:36px 5%;text-align:center;margin-top:48px}
    @media (max-width:980px){
      main{grid-template-columns:1fr;padding:0 4%}
      .hero h1{font-size:2rem}
    }
    @media (max-width:640px){
      .card .img-wrap{height:150px}
    }
  </style>
</head>
<body>
  <header>
    <div style="display:flex;align-items:center;gap:12px">
      <a class="logo" href="#" onclick="showHome()">WealthWise <span style="font-size:.7rem;margin-left:8px" class="status">Autonomous</span></a>
    </div>

    <div class="controls">
      <div id="gen-status" style="display:none" class="status">Generating…</div>
      <button class="btn secondary" id="btn-manual">Generate Now</button>
      <button class="btn" id="btn-settings">Settings</button>
    </div>
  </header>

  <section class="hero">
    <h1>Expert Wealth Intelligence</h1>
    <p>Automated financial analysis powered by advanced AI — two deep-dive articles generated daily with relevant imagery.</p>
  </section>

  <main>
    <section>
      <div id="blog-grid" class="blog-grid">
        <!-- cards injected here -->
      </div>
    </section>

    <aside>
      <div class="box">
        <h4 style="margin:0 0 10px;font-family:'Playfair Display',serif;color:var(--primary-blue)">About WealthWise</h4>
        <p class="small-muted">This blog generates two original financial articles per day using your configured Gemini and Unsplash credentials. Keys are stored locally in your browser for GitHub Pages usage. See Settings for more.</p>
      </div>

      <div class="box" id="credits">
        <strong>Image attribution</strong>
        <p class="small-muted" id="image-attribution">Images fetched from Unsplash when available.</p>
      </div>

      <div class="box">
        <strong>Local storage</strong>
        <p class="small-muted">Generated posts are cached in your browser. Clearing site data will remove them.</p>
      </div>
    </aside>
  </main>

  <div id="post-view">
    <div style="max-width:1200px;margin:0 auto">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:0 5%;margin-bottom:14px">
        <a href="#" onclick="showHome()" style="text-decoration:none;color:var(--accent-gold);font-weight:700">← Back to home</a>
        <div class="small-muted" id="post-date"></div>
      </div>

      <div class="post-content" id="post-body"><!-- post content --></div>
    </div>
  </div>

  <footer>
    <p>&copy; 2026 WealthWise AI. Built for consistent financial education.</p>
    <p style="font-size:.76rem;margin-top:8px;opacity:.6">Powered by Gemini & Unsplash (You must provide API keys in Settings)</p>
  </footer>

  <!-- Settings modal -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal" role="document">
      <h3 style="margin-top:0">Settings & API Keys</h3>

      <div style="margin-top:8px">
        <div class="form-row">
          <label>Gemini API Key</label>
          <input id="gemini-key" placeholder="Paste Gemini API key (Bearer)" />
        </div>

        <div class="form-row">
          <label>Gemini Model</label>
          <select id="gemini-model">
            <option value="models/gemini-2.5">gemini-2.5</option>
            <option value="models/gemini-2.1">gemini-2.1</option>
            <option value="models/gemini-1.0">gemini-1.0</option>
          </select>
        </div>

        <div class="form-row">
          <label>Unsplash Key</label>
          <input id="unsplash-key" placeholder="Unsplash Access Key (Client ID)" />
        </div>

        <div class="form-row">
          <label>Posts per day</label>
          <input id="posts-per-day" type="number" min="1" max="10" value="2" />
        </div>

        <div style="margin-top:10px;color:#7b8794;font-size:.9rem">
          NOTE: Keys stored in-browser are visible to anyone who can view the site. For production, use a server or serverless function to keep keys secret.
        </div>

        <div class="actions">
          <button class="btn secondary" id="btn-cancel">Cancel</button>
          <button class="btn" id="btn-save">Save</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Local storage keys
    const STORAGE_POSTS_KEY = 'ww_posts_v1';
    const STORAGE_META_KEY = 'ww_meta_v1';

    // UI elements
    const blogGrid = document.getElementById('blog-grid');
    const genStatus = document.getElementById('gen-status');
    const btnManual = document.getElementById('btn-manual');
    const btnSettings = document.getElementById('btn-settings');
    const modal = document.getElementById('modal');
    const btnCancel = document.getElementById('btn-cancel');
    const btnSave = document.getElementById('btn-save');
    const geminiKeyInput = document.getElementById('gemini-key');
    const geminiModelSelect = document.getElementById('gemini-model');
    const unsplashKeyInput = document.getElementById('unsplash-key');
    const postsPerDayInput = document.getElementById('posts-per-day');
    const imageAttributionEl = document.getElementById('image-attribution');

    // Post view elements
    const postView = document.getElementById('post-view');
    const postBody = document.getElementById('post-body');
    const postDateEl = document.getElementById('post-date');

    // App state
    let posts = [];
    let meta = {
      lastGeneratedDate: null,
      postsPerDay: 2,
      geminiKey: '',
      geminiModel: 'models/gemini-2.5',
      unsplashKey: ''
    };

    // Initialize
    (function init(){
      loadMeta();
      loadPosts();
      renderGrid();
      setupUI();

      // On load, if no posts or date is old, run generation
      const todayStr = new Date().toDateString();
      if (meta.lastGeneratedDate !== todayStr) {
        runDailyUpdate(todayStr).catch(e => console.error('Auto update failed', e));
      }
    })();

    function setupUI(){
      btnManual.addEventListener('click', async () => {
        await runManualGeneration();
      });
      btnSettings.addEventListener('click', openSettings);
      btnCancel.addEventListener('click', closeSettings);
      btnSave.addEventListener('click', saveSettings);
      modal.addEventListener('click', (e)=>{ if(e.target===modal) closeSettings(); });

      // populate settings fields
      geminiKeyInput.value = meta.geminiKey || '';
      geminiModelSelect.value = meta.geminiModel || 'models/gemini-2.5';
      unsplashKeyInput.value = meta.unsplashKey || '';
      postsPerDayInput.value = meta.postsPerDay || 2;
    }

    function openSettings(){
      geminiKeyInput.value = meta.geminiKey || '';
      geminiModelSelect.value = meta.geminiModel || 'models/gemini-2.5';
      unsplashKeyInput.value = meta.unsplashKey || '';
      postsPerDayInput.value = meta.postsPerDay || 2;
      modal.style.display = 'flex';
    }
    function closeSettings(){ modal.style.display = 'none'; }

    function saveSettings(){
      meta.geminiKey = geminiKeyInput.value.trim();
      meta.geminiModel = geminiModelSelect.value;
      meta.unsplashKey = unsplashKeyInput.value.trim();
      meta.postsPerDay = Math.max(1, Math.min(10, Number(postsPerDayInput.value) || 2));
      saveMeta();
      closeSettings();
      renderGrid();
    }

    function loadPosts(){
      try{
        const raw = localStorage.getItem(STORAGE_POSTS_KEY);
        posts = raw ? JSON.parse(raw) : [];
      }catch(e){ posts = []; }
    }
    function savePosts(){
      localStorage.setItem(STORAGE_POSTS_KEY, JSON.stringify(posts));
    }
    function loadMeta(){
      try{
        const raw = localStorage.getItem(STORAGE_META_KEY);
        if(raw){
          const parsed = JSON.parse(raw);
          meta = {...meta, ...parsed};
        }
      }catch(e){}
    }
    function saveMeta(){
      localStorage.setItem(STORAGE_META_KEY, JSON.stringify(meta));
    }

    async function runDailyUpdate(todayStr){
      genStatus.style.display = 'inline-block';
      genStatus.textContent = 'Generating today\'s posts…';
      try{
        // generate postsPerDay posts
        for(let i=0;i<meta.postsPerDay;i++){
          const post = await generateAIPost();
          posts.unshift(post);
        }
        // keep only last 60
        posts = posts.slice(0, 60);
        meta.lastGeneratedDate = todayStr;
        savePosts();
        saveMeta();
        renderGrid();
      }catch(e){
        console.error('Daily update error', e);
        // swallow to not break UX
      }finally{
        genStatus.style.display = 'none';
      }
    }

    async function runManualGeneration(){
      genStatus.style.display = 'inline-block';
      genStatus.textContent = 'Manual generation…';
      try{
        const post = await generateAIPost();
        posts.unshift(post);
        posts = posts.slice(0,60);
        savePosts();
        renderGrid();
      }catch(e){
        alert('Generation failed: ' + (e.message || e));
        console.error(e);
      }finally{
        genStatus.style.display = 'none';
      }
    }

    // Main generator: Gemini for content + Unsplash for image
    async function generateAIPost(){
      if(!meta.geminiKey){
        throw new Error('Missing Gemini API key. Open Settings and paste your key.');
      }
      // Choose a random topical seed
      const topics = [
        "Stock Market Trends", "Crypto Regulation", "Real Estate Investing",
        "Passive Income Strategies", "Retirement Planning", "Global Inflation",
        "Tech Stocks & AI Investing", "Sustainable Investing", "Fixed Income Strategies"
      ];
      const topic = topics[Math.floor(Math.random()*topics.length)];

      // Build instruction: ask for JSON strictly
      const instruction = `Write a high-quality professional financial blog post about "${topic}".
Return output as a strict JSON object only (no extra text) with keys:
"title" - a compelling title (string),
"tag" - one word tag (Investing, Market, Wealth, Crypto, RealEstate),
"excerpt" - a 1-2 sentence teaser plain text (string),
"content" - HTML string with 4 paragraphs enclosed in <p>..</p> tags (string),
"image_keyword" - 1-2 words suitable to search a photo (string).
Do not include any other fields. Keep JSON parseable.`;

      // Call Gemini
      const modelPath = meta.geminiModel || 'models/gemini-2.5';
      const url = `https://generativelanguage.googleapis.com/v1beta/${modelPath}:generate`;
      const payload = {
        // The API accepts "contents" style; this matches common generativelanguage usage
        // generationConfig instructs the model to return application/json
        "contents": [{ "parts": [{ "text": instruction }] }],
        "temperature": 0.2,
        "maxOutputTokens": 800,
        "generationConfig": { "responseMimeType": "application/json" }
      };

      const glResponse = await fetchWithRetry(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${meta.geminiKey}`
        },
        body: JSON.stringify(payload)
      }, 3);

      // Parse expected model structure. We try multiple shapes to be robust.
      let candidateText = null;
      try {
        if (glResponse?.candidates?.[0]?.content?.parts?.[0]?.text) {
          candidateText = glResponse.candidates[0].content.parts[0].text;
        } else if (glResponse?.candidates?.[0]?.output) {
          candidateText = glResponse.candidates[0].output;
        } else if (typeof glResponse?.output === 'string') {
          candidateText = glResponse.output;
        } else {
          // fallback: stringified entire response
          candidateText = JSON.stringify(glResponse);
        }
      } catch(e){
        candidateText = JSON.stringify(glResponse);
      }

      // The model is instructed to return JSON. Parse it.
      let postData;
      try {
        // Trim and recover JSON text only (strip leading/trailing code fences or commentary)
        const jsonText = extractJSON(candidateText);
        postData = JSON.parse(jsonText);
      } catch(e){
        console.error('Failed to parse Gemini response as JSON', candidateText, e);
        throw new Error('Failed to parse content from Gemini. Check model output or key.');
      }

      // Get an image from Unsplash for image_keyword
      let image = null;
      let attribution = null;
      if (meta.unsplashKey && postData.image_keyword) {
        try {
          const imgObj = await fetchUnsplashImage(postData.image_keyword);
          image = imgObj?.url || null;
          attribution = imgObj?.attribution || null;
        }catch(e){
          console.warn('Unsplash fetch failed, will fallback to generic image', e);
        }
      }

      // fallback image generation: unsplash source unsplash.com with a random seed (no API)
      if(!image){
        const seed = Math.floor(Math.random()*99999);
        const kw = encodeURIComponent(postData.image_keyword || topic);
        image = `https://images.unsplash.com/photo-1554224155-6726b3ff858f?auto=format&fit=crop&q=80&w=1200&sig=${seed}&utm_source=wealthwise_auto&utm_medium=referral`;
        attribution = null;
      }

      const id = Date.now().toString(36) + '-' + Math.floor(Math.random()*9999);
      const date = new Date().toLocaleDateString();

      const post = {
        id,
        title: postData.title || topic,
        tag: postData.tag || 'Investing',
        excerpt: postData.excerpt || '',
        content: postData.content || '<p>Content unavailable.</p>',
        image,
        image_attribution: attribution,
        generated_from_topic: topic,
        date
      };

      return post;
    }

    // Robust fetch + retry utility
    async function fetchWithRetry(url, opts = {}, retries = 3, backoff = 800){
      for(let i=0;i<=retries;i++){
        try{
          const res = await fetch(url, opts);
          const text = await res.text();
          // Try parse as JSON - some endpoints return JSON
          try { return JSON.parse(text); } catch(e){ return text; }
        }catch(e){
          if(i===retries) throw e;
          await new Promise(r => setTimeout(r, backoff * Math.pow(2, i)));
        }
      }
    }

    async function fetchUnsplashImage(keyword){
      // Use official endpoint for a random photo that matches query
      const url = `https://api.unsplash.com/photos/random?query=${encodeURIComponent(keyword)}&orientation=landscape&content_filter=high&w=1920`;
      const res = await fetch(url, {
        headers: {
          'Authorization': `Client-ID ${meta.unsplashKey}`,
          'Accept-Version': 'v1'
        }
      });
      if(!res.ok) throw new Error('Unsplash fetch failed: ' + res.status);
      const json = await res.json();
      // Prefer "urls" object for controlled size
      const photoUrl = json?.urls?.regular || json?.urls?.full || json?.urls?.raw;
      const attribution = json?.user ? `${json.user.name} / Unsplash` : null;
      const photographerLink = json?.user?.links?.html ? json.user.links.html : null;
      return { url: photoUrl, attribution: attribution ? `${attribution}${photographerLink ? ' — ' + photographerLink : ''}` : null };
    }

    // Render UI grid
    function renderGrid(){
      // Update attribution box with latest image attribution if any
      const lastAttr = posts.find(p => p.image_attribution)?.image_attribution;
      if(lastAttr) imageAttributionEl.innerHTML = `Latest photo: ${escapeHtml(lastAttr)}`;
      else imageAttributionEl.innerHTML = `Images fetched from Unsplash or Unsplash Source`;

      if(posts.length === 0){
        blogGrid.innerHTML = `<div style="grid-column:1/-1;padding:24px;background:var(--white);border-radius:10px;border:1px dashed #e6eef6">No posts yet — site will auto-generate content. Click "Generate Now" to create one immediately.</div>`;
        return;
      }

      blogGrid.innerHTML = posts.map(post => `
        <article class="card" onclick="openPost('${post.id}')">
          <div class="img-wrap">${post.image ? `<img loading="lazy" src="${escapeAttr(post.image)}" alt="${escapeAttr(post.title)}">` : ''}</div>
          <div class="card-body">
            <div class="tag">${escapeHtml(post.tag)}</div>
            <h3>${escapeHtml(post.title)}</h3>
            <p>${escapeHtml(post.excerpt)}</p>
            <div style="display:flex;justify-content:space-between;align-items:center">
              <small style="color:#7b8794">${escapeHtml(post.date)}</small>
              <small style="color:#7b8794">By WealthWise AI</small>
            </div>
          </div>
        </article>
      `).join('');
    }

    // Post view
    window.openPost = function(id){
      const post = posts.find(p => p.id === id);
      if(!post) return;
      postView.style.display = 'block';
      document.documentElement.scrollTop = 0;
      postDateEl.textContent = post.date + ' • WealthWise AI';
      const attributionHtml = post.image_attribution ? `<div style="font-size:.85rem;color:#7b8794;margin-top:8px">Photo: ${escapeHtml(post.image_attribution)}</div>` : '';
      postBody.innerHTML = `
        <div style="padding-bottom:8px">
          <div class="tag">${escapeHtml(post.tag)}</div>
          <h1>${escapeHtml(post.title)}</h1>
          ${post.image ? `<img src="${escapeAttr(post.image)}" alt="${escapeAttr(post.title)}" class="post-img">` : ''}
          ${attributionHtml}
        </div>
        <div class="post-text">${post.content}</div>
      `;
    };
    function showHome(){
      postView.style.display = 'none';
      document.documentElement.scrollTop = 0;
    }
    window.showHome = showHome;

    // Utilities
    function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    // Try to extract JSON embedded in model responses (strip code fences, text)
    function extractJSON(text){
      if(!text) return text;
      // Remove markdown code fences if present
      let t = text.trim();
      // If triple backticks present, get inside
      const fenceMatch = t.match(/```(?:json)?\s*([\s\S]*?)```/i);
      if(fenceMatch) t = fenceMatch[1].trim();
      // If camera left/right commentary, try to find first { ... } block
      const firstBrace = t.indexOf('{');
      const lastBrace = t.lastIndexOf('}');
      if(firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace){
        t = t.substring(firstBrace, lastBrace+1);
      }
      return t;
    }

    // Expose save/load for debugging from console
    window._ww = { posts, meta, savePosts, saveMeta, generateAIPost };

    // End of script
  </script>
</body>
</html>


name=index.html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WealthWise AI — Autonomous Wealth Intelligence</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <!-- GSAP for rich motion, Chart.js for sparklines -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>

  <style>
    :root{
      --deep-blue:#071032;
      --navy:#0f172a;
      --gold:#cfa15a;
      --gold-2:#b98e43;
      --wealth-green:#0ec27a;
      --muted:#7b8794;
      --card:#ffffff;
      --bg:#f6f8fb;
      --glass: rgba(255,255,255,0.06);
      --transition: all .35s cubic-bezier(.22,.9,.35,1);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#f8fafc 0%, #eef2f7 100%);color:#0b1b2b; -webkit-font-smoothing:antialiased;
    }

    /* Header */
    header{
      position:sticky;top:0;z-index:60;background:linear-gradient(90deg, rgba(3,7,18,0.98), rgba(10,16,28,0.98));
      color:var(--card);backdrop-filter: blur(6px);padding:14px 5%;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.03)
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{font-family:'Playfair Display',serif;color:var(--gold);font-size:1.5rem;text-decoration:none;font-weight:700}
    nav{display:flex;gap:18px;align-items:center}
    nav a{color:rgba(255,255,255,0.9);text-decoration:none;font-weight:600;font-size:.88rem;opacity:.95}
    .controls{display:flex;gap:10px;align-items:center}
    .btn{background:var(--gold);color:var(--navy);border:none;padding:9px 12px;border-radius:9px;font-weight:700;cursor:pointer;transition:var(--transition)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:rgba(255,255,255,0.92)}
    .pill{background:#fff1d6;color:var(--navy);padding:6px 10px;border-radius:999px;font-weight:800;font-size:.8rem}

    /* Hero */
    .hero{
      position:relative;padding:64px 5% 40px;overflow:hidden;color:#fff;
      background:linear-gradient(180deg, rgba(5,9,20,0.75), rgba(9,14,26,0.7));
    }
    /* particle canvas spans the hero */
    #hero-canvas{position:absolute;inset:0;pointer-events:none;opacity:.12}
    .hero-inner{position:relative;z-index:2;display:grid;grid-template-columns:1fr 420px;gap:28px;align-items:center;max-width:1200px;margin:0 auto}
    .hero-title{font-family:'Playfair Display',serif;font-size:2.6rem;margin-bottom:10px;line-height:1.02}
    .hero-sub{color:#cbd5e1;font-size:1.05rem;max-width:560px}
    .market-cards{display:flex;flex-direction:column;gap:12px}
    .market-card{background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));padding:14px;border-radius:12px;backdrop-filter: blur(8px);border:1px solid rgba(255,255,255,0.04)}
    .market-row{display:flex;justify-content:space-between;align-items:center}
    .m-title{font-size:.9rem;color:#cbd5e1}
    .m-value{font-weight:800;font-size:1.15rem;color:var(--gold);}

    /* Main layout */
    main{max-width:1200px;margin:28px auto;padding:0 5%;display:grid;grid-template-columns:1fr 320px;gap:26px;align-items:start}
    /* Blog grid */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:18px}
    .card{
      background:var(--card);border-radius:12px;overflow:hidden;border:1px solid #e6eef6;box-shadow:0 10px 28px rgba(2,6,23,.06);cursor:pointer;transition:var(--transition);
      display:flex;flex-direction:column;
    }
    .card:hover{transform:translateY(-8px);box-shadow:0 20px 40px rgba(2,6,23,.08)}
    .card-visual{height:190px;position:relative;overflow:hidden;background:#f0f3f8}
    .card-visual img{width:100%;height:100%;object-fit:cover;display:block;transition:transform .8s cubic-bezier(.2,.9,.2,1)}
    .card:hover .card-visual img{transform:scale(1.06)}
    .card-body{padding:16px;display:flex;flex-direction:column;gap:8px}
    .tag{color:var(--gold);font-weight:800;font-size:.72rem;text-transform:uppercase;letter-spacing:0.8px}
    .title{font-family:'Playfair Display',serif;font-size:1.12rem;color:var(--navy);margin-top:6px}
    .excerpt{color:var(--muted);font-size:.95rem}
    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:auto;color:#97a3b0}
    .meta small{font-size:.84rem}

    /* Sparkline canvas container */
    .sparkline{width:120px;height:36px}

    /* Sidebar */
    aside{display:flex;flex-direction:column;gap:16px}
    .side-card{background:var(--card);padding:14px;border-radius:12px;border:1px solid #e6eef6;box-shadow:0 6px 22px rgba(2,6,23,.04)}
    .ad-slot{display:flex;align-items:center;justify-content:center;height:90px;border-radius:8px;background:#f7fafc;border:1px dashed #e1e8f0;color:#94a3b8}
    .ad-mpu{height:300px;display:flex;align-items:center;justify-content:center;border-radius:10px;background:#fafcff;border:1px dashed #e1e8f0;color:#94a3b8}

    .filters{display:flex;gap:10px;flex-wrap:wrap}
    .filter-btn{padding:8px 10px;border-radius:999px;border:1px solid #e6eef6;background:transparent;color:var(--navy);cursor:pointer;font-weight:600}
    .filter-btn.active{background:var(--gold);color:var(--navy)}

    /* Interactions (likes/bookmark) */
    .actions{display:flex;gap:10px;align-items:center}
    .icon-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:6px;border-radius:8px}

    /* Post view */
    #post-view{display:none;padding:36px 5% 60px}
    .post-wrap{max-width:960px;margin:0 auto;background:var(--card);padding:28px;border-radius:12px;border:1px solid #e6eef6}
    .post-wrap h1{font-family:'Playfair Display',serif;font-size:2rem;color:var(--navy)}
    .post-img{width:100%;height:420px;object-fit:cover;border-radius:10px;margin:18px 0}
    .post-content{color:#16324a;line-height:1.72}

    /* Settings modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,0.52);display:none;align-items:center;justify-content:center;padding:20px;z-index:80}
    .modal{background:var(--card);padding:18px;border-radius:10px;max-width:720px;width:100%;box-shadow:0 18px 60px rgba(2,6,23,0.45)}
    .form-row{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    .form-row label{width:140px;font-weight:700;color:#223645}
    .form-row input, .form-row select, .form-row textarea{flex:1;padding:8px;border-radius:8px;border:1px solid #e6eef6}

    footer{margin-top:48px;padding:34px 5%;text-align:center;color:#94a3b8;background:transparent}

    @media (max-width:1000px){
      .hero-inner{grid-template-columns:1fr}
      main{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <a class="logo" href="#" onclick="showHome()">WealthWise</a>
      <div style="display:flex;flex-direction:column">
        <small style="color:rgba(255,255,255,0.7);font-weight:700">Autonomous Finance</small>
        <small style="color:rgba(255,255,255,0.45);font-size:.78rem">Daily insights • Market intelligence</small>
      </div>
    </div>

    <nav>
      <a href="#" onclick="showHome()">Home</a>
      <a href="#" onclick="filterBy('Market')">Markets</a>
      <a href="#" onclick="filterBy('Investing')">Investing</a>
      <a href="#" onclick="openSettings()">Settings</a>
      <div style="width:12px"></div>
      <div class="pill" id="live-pill">LIVE</div>
    </nav>
  </header>

  <section class="hero" aria-hidden="false">
    <canvas id="hero-canvas"></canvas>
    <div class="hero-inner">
      <div>
        <div style="display:flex;gap:12px;align-items:center">
          <h1 class="hero-title">Wealth intelligence that works while you sleep</h1>
        </div>
        <p class="hero-sub">We generate two deeply-researched financial articles daily. Animated charts, live-feel market cards, and bespoke images keep visitors exploring.</p>

        <div style="display:flex;gap:12px;margin-top:18px;align-items:center">
          <button class="btn" id="cta-generate">Generate Now</button>
          <button class="btn ghost" onclick="openSettings()">API Settings</button>
          <div style="flex:1"></div>
        </div>

        <div style="display:flex;gap:12px;margin-top:18px">
          <div class="market-card" style="flex:1">
            <div class="market-row">
              <div>
                <div class="m-title">Market Pulse</div>
                <div class="m-value" id="mp-index">34,298</div>
              </div>
              <div style="text-align:right;">
                <div class="m-title">Change</div>
                <div style="color:var(--wealth-green);font-weight:800" id="mp-change">+1.24%</div>
              </div>
            </div>
          </div>

          <div class="market-card" style="width:140px">
            <div class="m-title">Volatility</div>
            <div class="m-value" id="mp-vol">12.4</div>
          </div>
        </div>
      </div>

      <aside>
        <div class="market-cards" aria-hidden="true">
          <div class="market-card" title="Daily sentiment">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="m-title">Sentiment</div>
                <div style="font-weight:800;color:#e8f9ee">Bullish</div>
              </div>
              <div style="text-align:right">
                <div class="m-title">Confidence</div>
                <div style="font-weight:800;color:var(--gold)">86%</div>
              </div>
            </div>
          </div>

          <div class="market-card" id="insight-card">
            <div style="font-weight:800;color:var(--navy)">AI Insight</div>
            <div style="color:var(--muted);margin-top:8px;font-size:.95rem" id="ai-insight">Autonomous systems detect rotation into value names. Tap to explore insights.</div>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <main>
    <section>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="display:flex;gap:12px;align-items:center">
          <h2 style="margin:0;font-family:'Playfair Display',serif">Latest Intelligence</h2>
          <div style="color:var(--muted);font-weight:600">— curated by WealthWise AI</div>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <input id="search" placeholder="Search topics, e.g. inflation, crypto..." style="padding:8px 10px;border-radius:10px;border:1px solid #e6eef6;min-width:220px" />
          <button class="btn ghost" id="btn-filter-toggle">Filters</button>
        </div>
      </div>

      <div style="display:flex;gap:12px;margin-bottom:12px;align-items:center">
        <div class="filters" id="filters">
          <!-- dynamic tag buttons -->
        </div>
      </div>

      <div class="grid" id="grid">
        <!-- cards injected -->
      </div>

      <div style="margin:18px 0;display:flex;justify-content:center">
        <div class="ad-slot" id="leaderboard-ad">Leaderboard Ad (728x90 placeholder)</div>
      </div>
    </section>

    <aside>
      <div class="side-card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>Explore</strong>
          <small style="color:var(--muted)"><span id="total-posts">0</span> posts</small>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-direction:column">
          <button class="filter-btn" onclick="filterBy('All')">All</button>
          <button class="filter-btn" onclick="filterBy('Investing')">Investing</button>
          <button class="filter-btn" onclick="filterBy('Market')">Markets</button>
          <button class="filter-btn" onclick="filterBy('Wealth')">Wealth</button>
          <button class="filter-btn" onclick="filterBy('Crypto')">Crypto</button>
        </div>
      </div>

      <div class="side-card">
        <strong>Stay on site</strong>
        <p class="small-muted">Animated micro-interactions and mini charts keep users exploring. Ads can be placed here (MPU) and in the feed.</p>
        <div style="margin-top:12px" class="ad-mpu">Sidebar Ad (300x600 placeholder)</div>
      </div>

      <div class="side-card" id="bookmarks-box">
        <strong>Your bookmarks</strong>
        <div id="bookmarks-list" style="margin-top:10px;color:var(--muted)">No bookmarks yet</div>
      </div>
    </aside>
  </main>

  <!-- Post view -->
  <div id="post-view">
    <div style="display:flex;justify-content:space-between;align-items:center;max-width:1200px;margin:0 auto;padding:0 5%;margin-bottom:12px">
      <a href="#" onclick="showHome()" style="color:var(--gold);font-weight:800;text-decoration:none">← Back to feed</a>
      <div style="display:flex;gap:12px;align-items:center">
        <button class="btn ghost" onclick="sharePost()">Share</button>
        <button class="btn" onclick="saveToBookmarks()">Bookmark</button>
      </div>
    </div>
    <div class="post-wrap" id="post-wrap" style="max-width:900px;margin:0 auto">
      <!-- content injected -->
    </div>
  </div>

  <footer>
    <div>© 2026 WealthWise AI • Built for persistent, modern financial education</div>
    <div style="font-size:.82rem;color:var(--muted);margin-top:6px">Powered by Gemini & Unsplash. For production, proxy API calls server-side to keep keys secret.</div>
  </footer>

  <!-- Settings modal -->
  <div id="modal" class="modal-backdrop" role="dialog" aria-modal="true">
    <div class="modal">
      <h3 style="margin-top:0">Settings & API Keys</h3>

      <div class="form-row">
        <label>Gemini Bearer</label>
        <input id="gemini-key" placeholder="Paste Bearer token (starts with 'ya29.' or Bearer token)" />
      </div>
      <div class="form-row">
        <label>Model</label>
        <select id="gemini-model">
          <option value="models/gemini-2.5">gemini-2.5</option>
          <option value="models/gemini-2.1">gemini-2.1</option>
        </select>
      </div>
      <div class="form-row">
        <label>Unsplash Key</label>
        <input id="unsplash-key" placeholder="Unsplash Access Key (Client ID)" />
      </div>
      <div class="form-row">
        <label>Posts/day</label>
        <input id="posts-per-day" type="number" min="1" max="10" value="2" />
      </div>

      <div style="margin-top:8px;color:#6b7785;font-size:.9rem">
        Keys stored in your browser localStorage. For production keep keys in a serverless proxy or environment variables.
      </div>

      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button class="btn ghost" id="btn-cancel">Cancel</button>
        <button class="btn" id="btn-save">Save</button>
      </div>
    </div>
  </div>

  <script>
/* -----------------------
   App: WealthWise Autonomous Blog (interactive + animated)
   - Uses Gemini for content generation (API key required)
   - Uses Unsplash to fetch images (Access Key required)
   - Heavy emphasis on motion via GSAP + ScrollTrigger + canvas particles
   - Chart.js used to render miniature sparklines in cards
   - LocalStorage used for posts, meta, bookmarks
   - NOTE: Storing secrets client-side is visible to visitors. For real deployment, proxy via serverless.
-------------------------*/

const POSTS_KEY = 'ww_posts_v3';
const META_KEY = 'ww_meta_v3';
const BOOKMARKS_KEY = 'ww_bookmarks_v3';

// DOM refs
const grid = document.getElementById('grid');
const filtersEl = document.getElementById('filters');
const searchInput = document.getElementById('search');
const totalPostsEl = document.getElementById('total-posts');
const leaderboardAd = document.getElementById('leaderboard-ad');
const ctaGenerate = document.getElementById('cta-generate');

// modal refs
const modal = document.getElementById('modal');
const geminiKeyInput = document.getElementById('gemini-key');
const geminiModelSelect = document.getElementById('gemini-model');
const unsplashKeyInput = document.getElementById('unsplash-key');
const postsPerDayInput = document.getElementById('posts-per-day');
const btnCancel = document.getElementById('btn-cancel');
const btnSave = document.getElementById('btn-save');

let posts = [];
let meta = {
  geminiKey: '',
  geminiModel: 'models/gemini-2.5',
  unsplashKey: '',
  postsPerDay: 2,
  lastGeneratedDate: null
};
let bookmarks = [];

/* --- Initialization --- */
function init(){
  loadState();
  populateFilters();
  renderGrid();
  renderBookmarks();
  attachHandlers();
  animateHeroNumbers();
  initHeroParticles();
  initScrollAnimations();

  // Auto generate if not generated today
  const today = new Date().toDateString();
  if (meta.lastGeneratedDate !== today){
    autoGenerateDaily(today);
  }
}
init();

/* --- Storage --- */
function loadState(){
  try{ posts = JSON.parse(localStorage.getItem(POSTS_KEY)) || []; }catch(e){ posts=[]; }
  try{ meta = {...meta, ...(JSON.parse(localStorage.getItem(META_KEY))||{})}; }catch(e){}
  try{ bookmarks = JSON.parse(localStorage.getItem(BOOKMARKS_KEY)) || []; }catch(e){ bookmarks = []; }
}
function saveState(){
  localStorage.setItem(POSTS_KEY, JSON.stringify(posts));
  localStorage.setItem(META_KEY, JSON.stringify(meta));
  localStorage.setItem(BOOKMARKS_KEY, JSON.stringify(bookmarks));
}

/* --- UI Handlers --- */
function attachHandlers(){
  document.getElementById('btn-filter-toggle').addEventListener('click', ()=> {
    filtersEl.scrollIntoView({behavior:'smooth', block:'center'});
  });
  document.getElementById('btn-cancel').addEventListener('click', closeSettings);
  document.getElementById('btn-save').addEventListener('click', saveSettings);
  document.getElementById('cta-generate').addEventListener('click', manualGenerate);
  document.getElementById('search').addEventListener('input', renderGrid);
  document.getElementById('btn-filter-toggle').addEventListener('click', ()=> {}); // placeholder
  // open settings via header
  window.openSettings = openSettings;
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeSettings(); } );
  // initial fill of settings fields
  geminiKeyInput.value = meta.geminiKey || '';
  geminiModelSelect.value = meta.geminiModel || 'models/gemini-2.5';
  unsplashKeyInput.value = meta.unsplashKey || '';
  postsPerDayInput.value = meta.postsPerDay || 2;
}

/* --- Settings modal --- */
function openSettings(){
  geminiKeyInput.value = meta.geminiKey || '';
  geminiModelSelect.value = meta.geminiModel || 'models/gemini-2.5';
  unsplashKeyInput.value = meta.unsplashKey || '';
  postsPerDayInput.value = meta.postsPerDay || 2;
  modal.style.display = 'flex';
}
function closeSettings(){ modal.style.display = 'none'; }
function saveSettings(){
  meta.geminiKey = geminiKeyInput.value.trim();
  meta.geminiModel = geminiModelSelect.value;
  meta.unsplashKey = unsplashKeyInput.value.trim();
  meta.postsPerDay = Math.max(1, Math.min(10, Number(postsPerDayInput.value) || 2));
  saveState();
  closeSettings();
  alert('Settings saved locally. For production, use a serverless proxy to keep keys secret.');
}

/* --- Filters & Search --- */
const TAGS = ['Investing','Market','Wealth','Crypto','RealEstate','Passive Income','Retirement'];
function populateFilters(){
  const container = filtersEl;
  container.innerHTML = '';
  const allBtn = document.createElement('button');
  allBtn.className = 'filter-btn active';
  allBtn.textContent = 'All';
  allBtn.onclick = ()=> { filterBy('All'); };
  container.appendChild(allBtn);

  TAGS.forEach(t=>{
    const b = document.createElement('button');
    b.className = 'filter-btn';
    b.textContent = t;
    b.onclick = ()=> { filterBy(t); };
    container.appendChild(b);
  });
}

let activeFilter = 'All';
function filterBy(tag){
  activeFilter = tag;
  document.querySelectorAll('.filter-btn').forEach(el => el.classList.toggle('active', (el.textContent===tag || (tag==='All' && el.textContent==='All'))));
  renderGrid();
}

/* --- Rendering Grid --- */
function renderGrid(){
  const q = searchInput.value.trim().toLowerCase();
  const filtered = posts.filter(p => {
    if(activeFilter !== 'All' && p.tag && p.tag.toLowerCase() !== activeFilter.toLowerCase()) return false;
    if(q){
      const hay = (p.title + ' ' + p.excerpt + ' ' + (p.content || '')).toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });

  totalPostsEl.textContent = posts.length;
  if(filtered.length === 0){
    grid.innerHTML = `<div style="grid-column:1/-1;padding:22px;background:var(--card);border-radius:12px;border:1px dashed #e6eef6;color:var(--muted)">No posts found — generate some to start the feed.</div>`;
    return;
  }

  // Build cards
  grid.innerHTML = '';
  filtered.forEach(p=>{
    const el = document.createElement('article');
    el.className = 'card';
    el.innerHTML = `
      <div class="card-visual"><img src="${escapeAttr(p.image)}" alt="${escapeAttr(p.title)}" loading="lazy"></div>
      <div class="card-body">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div class="tag">${escapeHtml(p.tag)}</div>
            <div class="title">${escapeHtml(p.title)}</div>
          </div>
          <div class="actions">
            <button class="icon-btn" title="Like" data-like="${p.id}">❤</button>
          </div>
        </div>
        <div class="excerpt">${escapeHtml(p.excerpt)}</div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-top:12px">
          <div class="meta"><small>${escapeHtml(p.date)}</small></div>
          <div class="sparkline" id="spark-${p.id}"></div>
        </div>
      </div>
    `;
    el.onclick = (e)=> {
      // avoid when clicking like button
      if(e.target.getAttribute && e.target.getAttribute('data-like')) return;
      openPost(p.id);
    };
    grid.appendChild(el);

    // like handler
    el.querySelector('[data-like]')?.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      toggleBookmark(p.id);
      // micro animation
      gsap.fromTo(ev.target, {scale:0.9, color:'#d9534f'}, {scale:1.1, duration:0.25, yoyo:true, repeat:1, ease:'power1.inOut'});
    });

    // render sparkline
    const sparkEl = document.getElementById(`spark-${p.id}`);
    if(sparkEl){
      const canvas = document.createElement('canvas');
      canvas.width = 120; canvas.height = 36;
      sparkEl.appendChild(canvas);
      // small pseudo-data to animate - if post has "trend" data use it
      const data = p.trend || randomTrend();
      new Chart(canvas.getContext('2d'), {
        type: 'line',
        data: { labels: data.map((_,i)=>i), datasets: [{ data, borderColor: (data[data.length-1] >= data[0]) ? 'rgb(14,194,122)' : 'rgb(220,75,75)', borderWidth:1.8, tension:0.35, fill:false, pointRadius:0 }] },
        options:{responsive:false, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{x:{display:false},y:{display:false}}}
      });
    }
  });

  // run reveal animations
  gsap.fromTo('.card', {opacity:0, y:20}, {opacity:1, y:0, stagger:0.06, duration:0.6, ease:'power3.out', overwrite:true});
}

/* --- Open Post --- */
function openPost(id){
  const post = posts.find(p=>p.id===id);
  if(!post) return;
  document.getElementById('post-view').style.display = 'block';
  const postWrap = document.getElementById('post-wrap');
  const attribution = post.image_attribution ? `<div style="font-size:.86rem;color:var(--muted);margin-top:8px">Photo: ${escapeHtml(post.image_attribution)}</div>` : '';
  postWrap.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <div><span class="tag">${escapeHtml(post.tag)}</span> <small style="color:var(--muted);margin-left:8px">${escapeHtml(post.date)}</small></div>
      <div style="color:var(--muted)">By WealthWise AI</div>
    </div>
    <h1>${escapeHtml(post.title)}</h1>
    ${post.image ? `<img src="${escapeAttr(post.image)}" class="post-img" alt="${escapeAttr(post.title)}">` : ''}
    ${attribution}
    <div class="post-content">${post.content}</div>
  `;
  window.scrollTo({top:0, behavior:'smooth'});
}

/* --- Bookmarks --- */
function toggleBookmark(id){
  const idx = bookmarks.indexOf(id);
  if(idx === -1) bookmarks.push(id); else bookmarks.splice(idx,1);
  saveState();
  renderBookmarks();
}
function renderBookmarks(){
  const box = document.getElementById('bookmarks-list');
  if(bookmarks.length === 0){ box.innerHTML = 'No bookmarks yet'; return; }
  box.innerHTML = bookmarks.map(id=>{
    const p = posts.find(x=>x.id===id);
    return p ? `<div style="margin-bottom:8px"><a href="#" onclick="openPost('${p.id}');return false">${escapeHtml(p.title)}</a></div>` : '';
  }).join('');
}
function saveToBookmarks(){ /* invoked from post view: bookmark current open post by reading top h1 */ 
  const h1 = document.querySelector('#post-wrap h1');
  if(!h1) return;
  const title = h1.textContent;
  const post = posts.find(p => p.title === title);
  if(post){ if(!bookmarks.includes(post.id)) bookmarks.push(post.id); saveState(); renderBookmarks(); alert('Bookmarked'); }
}
function sharePost(){ alert('Share dialog placeholder — integrate Web Share API or social endpoints'); }

/* --- Data generation: Gemini + Unsplash --- */
async function autoGenerateDaily(todayStr){
  try{
    // set visual "live"
    document.getElementById('live-pill').textContent = 'UPDATING';
    for(let i=0;i<meta.postsPerDay;i++){
      const p = await generateAIPost();
      posts.unshift(p);
      await new Promise(r => setTimeout(r, 400)); // small spacing so UI updates
    }
    posts = posts.slice(0, 120);
    meta.lastGeneratedDate = todayStr;
    saveState();
    renderGrid();
  }catch(e){
    console.error('Daily generation failed', e);
  }finally{
    document.getElementById('live-pill').textContent = 'LIVE';
  }
}

async function manualGenerate(){
  try{
    document.getElementById('live-pill').textContent = 'GENERATING';
    const p = await generateAIPost();
    posts.unshift(p);
    posts = posts.slice(0,120);
    saveState();
    renderGrid();
    alert('New post generated');
  }catch(e){ alert('Generation failed: ' + (e.message || e)); console.error(e); }
  finally{ document.getElementById('live-pill').textContent = 'LIVE'; }
}

async function generateAIPost(){
  if(!meta.geminiKey){ throw new Error('Missing Gemini API key. Open Settings and paste your key.'); }
  const topics = ["Stock Market Trends","Crypto Regulation","Real Estate Investing","Passive Income Strategies","Retirement Planning","Global Inflation","Tech Stocks","Sustainable Investing"];
  const topic = topics[Math.floor(Math.random()*topics.length)];

  const instruction = `Write a high-quality professional financial blog post about "${topic}".
Return output as a strict JSON object (no extra text) with keys:
"title" (string),
"tag" (Investing, Market, Wealth, Crypto, RealEstate),
"excerpt" (1-2 sentences),
"content" (HTML string with 4 paragraphs using <p> tags),
"image_keyword" (1-2 words).
Respond only with the JSON object.`;

  const modelPath = meta.geminiModel || 'models/gemini-2.5';
  const url = `https://generativelanguage.googleapis.com/v1beta/${modelPath}:generate`;
  const payload = {
    contents: [{ parts: [{ text: instruction }] }],
    temperature: 0.2,
    maxOutputTokens: 700,
    generationConfig: { responseMimeType: "application/json" }
  };

  const raw = await fetchWithRetry(url, {
    method:'POST',
    headers: {
      'Content-Type':'application/json',
      'Authorization': `Bearer ${meta.geminiKey}`
    },
    body: JSON.stringify(payload)
  }, 2);

  // parse candidate text robustly
  let candidateText = null;
  try{
    if(raw?.candidates?.[0]?.content?.parts?.[0]?.text) candidateText = raw.candidates[0].content.parts[0].text;
    else if(typeof raw === 'string') candidateText = raw;
    else candidateText = JSON.stringify(raw);
  }catch(e){ candidateText = JSON.stringify(raw); }

  let parsed;
  try{
    const jsonText = extractJSON(candidateText);
    parsed = JSON.parse(jsonText);
  }catch(e){
    console.error('Gemini parse fail', candidateText, e);
    throw new Error('Failed to parse model output. Try different model or prompt.');
  }

  // attempt to fetch Unsplash image
  let image = null, attribution = null;
  if(meta.unsplashKey && parsed.image_keyword){
    try{
      const img = await fetchUnsplashImage(parsed.image_keyword);
      image = img.url;
      attribution = img.attribution;
    }catch(e){ console.warn('Unsplash fail', e); }
  }
  if(!image){
    const seed = Math.floor(Math.random()*999999);
    const kw = encodeURIComponent(parsed.image_keyword || topic);
    image = `https://images.unsplash.com/photo-1554224155-6726b3ff858f?auto=format&fit=crop&q=80&w=1600&sig=${seed}`;
  }

  const id = Date.now().toString(36) + '-' + Math.floor(Math.random()*9999);
  const date = new Date().toLocaleDateString();

  const post = {
    id, title: parsed.title || topic, tag: parsed.tag || 'Investing', excerpt: parsed.excerpt || '',
    content: parsed.content || '<p>Content unavailable.</p>', image, image_attribution: attribution, date,
    // small fake trend data for sparkline
    trend: randomTrend()
  };

  return post;
}

/* --- Fetch Helpers --- */
async function fetchWithRetry(url, init={}, retries=3, delay=700){
  for(let i=0;i<=retries;i++){
    try{
      const res = await fetch(url, init);
      const text = await res.text();
      try{ return JSON.parse(text); }catch(e){ return text; }
    }catch(e){
      if(i===retries) throw e;
      await new Promise(r => setTimeout(r, delay*(i+1)));
    }
  }
}

async function fetchUnsplashImage(keyword){
  const url = `https://api.unsplash.com/photos/random?query=${encodeURIComponent(keyword)}&orientation=landscape&content_filter=high`;
  const res = await fetch(url, { headers: { 'Authorization': `Client-ID ${meta.unsplashKey}`, 'Accept-Version':'v1' } });
  if(!res.ok) throw new Error('Unsplash responded ' + res.status);
  const json = await res.json();
  const photoUrl = json?.urls?.regular || json?.urls?.full || json?.urls?.raw;
  const attribution = json?.user ? `${json.user.name} / Unsplash` + (json.user.links?.html ? ` — ${json.user.links.html}` : '') : null;
  return { url: photoUrl, attribution };
}

/* --- Utilities --- */
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }
function extractJSON(text){
  if(!text) return text;
  let t = text.trim();
  // remove code fences
  const fence = /```(?:json)?\s*([\s\S]*?)```/i.exec(t);
  if(fence) t = fence[1].trim();
  // try find first { ... } block
  const first = t.indexOf('{'), last = t.lastIndexOf('}');
  if(first !== -1 && last !== -1 && last > first) t = t.slice(first, last+1);
  return t;
}
function randomTrend(len=20){
  const base = 100;
  const arr = [];
  let cur = base + (Math.random()*8-4);
  for(let i=0;i<len;i++){ cur += (Math.random()*4-2); arr.push(Math.round(cur*100)/100); }
  return arr;
}

/* --- Animations & Interactions --- */
function animateHeroNumbers(){
  // animate market pulse randomly on load
  const indexEl = document.getElementById('mp-index');
  const changeEl = document.getElementById('mp-change');
  const volEl = document.getElementById('mp-vol');
  const idx = 34298 + Math.floor(Math.random()*400);
  gsap.fromTo({v: idx-120}, {v:idx}, {
    duration:1.6, ease:'power2.out', onUpdate:function(){ indexEl.textContent = Math.round(this.target.v); }
  });
  const change = (Math.random()*2-0.5).toFixed(2);
  gsap.fromTo({v: (change-0.7)}, {v:change}, {
    duration:1.4, ease:'power2.out', onUpdate:function(){ changeEl.textContent = (this.target.v>=0?'+':'') + (Number(this.target.v).toFixed(2) + '%'); changeEl.style.color = this.target.v>=0? 'var(--wealth-green)':'#ff6b6b'; }
  });
  gsap.fromTo({v:10.1},{v:(10+Math.random()*5)}, {duration:1.2, ease:'power2.out', onUpdate:function(){ volEl.textContent = (Math.round(this.target.v*10)/10); }});
}

/* --- Hero particle background (simple canvas) --- */
function initHeroParticles(){
  const canvas = document.getElementById('hero-canvas');
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = canvas.clientWidth; canvas.height = canvas.clientHeight; }
  resize(); window.addEventListener('resize', resize);

  const particles = Array.from({length: 60}, ()=>({
    x: Math.random()*canvas.width, y: Math.random()*canvas.height,
    r: 0.6 + Math.random()*2.2, vx: (Math.random()-0.5)*0.2, vy: -0.2 - Math.random()*0.4,
    alpha: 0.06 + Math.random()*0.12
  }));

  function tick(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    particles.forEach(p=>{
      p.x += p.vx; p.y += p.vy;
      if(p.y < -10){ p.y = canvas.height + 10; p.x = Math.random()*canvas.width; }
      ctx.beginPath();
      ctx.fillStyle = `rgba(210,180,140,${p.alpha})`;
      ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
      ctx.fill();
    });
    requestAnimationFrame(tick);
  }
  tick();
}

/* --- Scroll-trigger reveal using GSAP + IntersectionObserver for performance --- */
function initScrollAnimations(){
  // reveal for new cards
  gsap.registerPlugin(ScrollTrigger);
  ScrollTrigger.defaults({toggleActions:'play none none reverse', scroller:document.body});
  // animate insight card
  gsap.from('#insight-card', {y:20, opacity:0, duration:1, ease:'power3.out', scrollTrigger:{trigger:'#insight-card', start:'top 85%'}});
}

window.addEventListener('load', ()=>{ renderGrid(); });

/* --- Simple utilities exposed for debugging --- */
window._ww = { posts, meta, bookmarks, saveState };

/* --- End of script */
  </script>
</body>
</html>
